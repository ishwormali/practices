package com.practices.todolist.db;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import com.practices.todolist.db.ToDoListDbContract.ToDoListDbEntry;
import com.practices.todolist.domain.ToDoListItem;

import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteDatabase.CursorFactory;
import android.database.sqlite.SQLiteOpenHelper;

public class ToDoListDbHelper extends SQLiteOpenHelper {

	
	public ToDoListDbHelper(Context context, String name,
			CursorFactory factory, int version) {
		super(context, DATABASE_NAME, null, DATABASE_VERSION);
		// TODO Auto-generated constructor stub
	}

	public static final int DATABASE_VERSION=1;
	public static final String DATABASE_NAME="ToDoList.db";
	
	public long InsertToDo(ToDoListItem item){
		Date nowDate=new Date();
		SQLiteDatabase db=getWritableDatabase();
		ContentValues values=new ContentValues();
		values.put(ToDoListDbEntry.COLUMN_NAME_ITEM_NAME, item.getItemName());
		values.put(ToDoListDbEntry.COLUMN_NAME_DATE_CREATED,nowDate.getTime());
		values.put(ToDoListDbEntry.COLUMN_NAME_DATE_UPDATED, nowDate.getTime());
		return db.insert(ToDoListDbEntry.TABLE_NAME, null, values);
		
	}
	
	public List<ToDoListItem> GetAll(){
		SQLiteDatabase db=getReadableDatabase();
		String sortOrder=ToDoListDbEntry.COLUMN_NAME_DATE_UPDATED + " desc";
		Cursor cursor=db.query(ToDoListDbEntry.TABLE_NAME, new String[]{}, null, null, null, null, sortOrder);
		int idIdx=cursor.getColumnIndex(ToDoListDbEntry.COLUMN_NAME_ID);
		int itemNameIdx=cursor.getColumnIndex(ToDoListDbEntry.COLUMN_NAME_ITEM_NAME);
		int dateCreatedIdx=cursor.getColumnIndex(ToDoListDbEntry.COLUMN_NAME_DATE_CREATED);
		int dateUpdatedIdx=cursor.getColumnIndex(ToDoListDbEntry.COLUMN_NAME_DATE_UPDATED);
		List<ToDoListItem> items=new ArrayList<ToDoListItem>();
		
		while(cursor.moveToNext()){
			ToDoListItem item=new ToDoListItem();
			int id=cursor.getInt(idIdx);
			String itemName=cursor.getString(itemNameIdx);
			
			Date dateCreated=new Date(cursor.getLong(dateCreatedIdx));
			Date dateUpdated=new Date(cursor.getLong(dateUpdatedIdx));
			item.setId(id);
			item.setItemName(itemName);
			item.setDateCreated(dateCreated);
			item.setDateUpdated(dateUpdated);
			items.add(item);
		}
		cursor.close();
		return items;
	}
	
	@Override
	public void onCreate(SQLiteDatabase db) {
		db.execSQL(ToDoListDbContract.SQL_CREATE_TABLE);

	}

	@Override
	public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
		db.execSQL(ToDoListDbContract.SQL_DROP_TABLE);
		onCreate(db);

	}

}
